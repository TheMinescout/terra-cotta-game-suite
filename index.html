<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe M3</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette */
            --bg: #FFFFFF;
            --text: #474D4D;       /* Dark Grey */
            --primary: #DD8566;    /* Terra Cotta */
            --surface: #F5F5F5;    /* Very light grey for contrast */
            --outline: #DBDCDF;    /* Light Grey for borders */
            
            /* Material 3 Specs */
            --radius-btn: 24px;    /* Pill shape */
            --radius-card: 16px;
            --shadow-1: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-2: 0 4px 16px rgba(0,0,0,0.1);
            
            --grid-line: #DBDCDF;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 { 
            text-align: center; 
            margin: 10px 0; 
            font-weight: 700;
            color: var(--text);
        }
        
        h1 { letter-spacing: -0.5px; margin-bottom: 30px; }

        p { text-align: center; color: #777; margin-bottom: 20px; }
        
        /* --- UI Screens --- */
        .screen {
            display: none;
            width: 100%;
            max-width: 600px;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.4s ease-out;
        }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Buttons & Inputs (Material 3 Style) --- */
        .btn-group { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin: 20px 0; 
            width: 100%;
        }
        
        button {
            padding: 14px 28px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            background-color: var(--bg);
            border: 1px solid var(--outline);
            color: var(--text);
            border-radius: var(--radius-btn);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-1);
        }

        button:hover { 
            background-color: var(--primary); 
            color: white; 
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-2);
        }
        
        button:active { transform: scale(0.98); }

        button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            border-color: #eee;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        input {
            padding: 14px;
            background: var(--surface);
            border: 1px solid transparent;
            border-bottom: 2px solid var(--outline);
            color: var(--text);
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-size: 1.1rem;
            margin: 10px 0;
            width: 80%;
            max-width: 300px;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus { border-bottom-color: var(--primary); background: #eaeaea; }
        
        .code-input { text-transform: uppercase; letter-spacing: 3px; font-weight: bold; }

        .code-box {
            background: var(--surface);
            padding: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 2rem;
            border-radius: var(--radius-card);
            margin: 20px;
            user-select: all;
            letter-spacing: 4px;
            color: var(--primary);
            font-weight: bold;
            border: 2px dashed var(--outline);
        }

        /* --- Scoreboard --- */
        #scoreboard {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
            background: var(--bg);
            padding: 15px 30px;
            border-radius: var(--radius-btn);
            box-shadow: var(--shadow-1);
            border: 1px solid var(--outline);
        }
        .score-item { text-align: center; }
        .score-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #999; }
        .score-val { font-size: 1.8rem; font-weight: 700; color: var(--text); }
        .score-active { color: var(--primary); }

        /* --- Game Board Styles --- */
        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            background: var(--bg);
            transition: background 0.2s;
            user-select: none;
            border-radius: 4px;
        }
        
        /* Animation */
        .cell.taken span { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Player Colors */
        .cell.x { color: var(--text); } /* Player 1 (Dark) */
        .cell.o { color: var(--primary); } /* Player 2 (Terra Cotta) */
        
        .cell:hover:not(.taken) { background-color: var(--surface); }

        /* 1. Normal 3x3 */
        #board-normal {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 4px;
            background: var(--outline); /* The grid lines */
            padding: 4px;
            border-radius: 12px;
        }
        #board-normal .cell { font-size: 3rem; background: var(--bg); border-radius: 8px;}

        /* 2. 3D 3x3x3 */
        #board-3d {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }
        .level-container {
            background: var(--surface);
            padding: 15px;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-1);
        }
        .layer-3d {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 3px;
            background: var(--outline);
            padding: 3px;
            transform: rotateX(10deg);
            border-radius: 8px;
        }
        .layer-label { font-size: 0.9rem; font-weight: 500; color: var(--primary); margin-bottom: 8px; }
        #board-3d .cell { font-size: 1.5rem; width: 50px; height: 50px; background: var(--bg); }

        /* 3. Ultimate Fixed Styles */
        #board-ultimate {
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 8px;
            background: var(--text); /* Dark thick lines for macro grid */
            padding: 8px;
            margin: 0 auto;
            border-radius: 12px;
        }
        .sub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            background: var(--outline); /* Light thin lines for micro grid */
            padding: 2px;
        }
        
        /* Active Zone Highlight (Subtle Terra Cotta Tint) */
        .sub-grid.active-zone { background: #FFDBCF; } 
        
        /* Won Subgrids */
        .sub-grid.won-x { background: #dcdcdc; opacity: 0.8; }
        .sub-grid.won-o { background: #EBCbc1; opacity: 0.8; }

        #board-ultimate .cell {
            width: 35px;
            height: 35px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
        }

        #turn-display { margin-top: 25px; font-size: 1.5rem; font-weight: 700; color: var(--text); }
        
        #restart-btn { 
            display: none; 
            margin-top: 30px; 
            background-color: var(--text); 
            color: white; 
            border: none;
        }
        #restart-btn:hover { background-color: black; }

        .back-link {
            margin-top: 30px; 
            background: transparent; 
            color: #999; 
            border: none; 
            box-shadow: none; 
            font-size: 0.9rem;
            text-decoration: underline;
        }
        .back-link:hover { background: transparent; color: var(--primary); transform: none; box-shadow: none; }

    </style>
</head>
<body>

    <h1>Master Tic-Tac-Toe</h1>

    <div id="screen-start" class="screen active">
        <h2>Select Mode</h2>
        <div class="btn-group">
            <button onclick="setupLocal()">Pass & Play</button>
            <button onclick="setupBot()">vs Bot</button>
            <button onclick="setupMultiplayerMenu()">Multiplayer</button>
        </div>
    </div>

    <div id="screen-local-setup" class="screen">
        <h2>Enter Names</h2>
        <input type="text" id="local-p1" placeholder="Player 1 Name (X)" value="Player 1">
        <input type="text" id="local-p2" placeholder="Player 2 Name (O)" value="Player 2">
        <div class="btn-group">
            <button onclick="finishSetup('local')">Next</button>
        </div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-mp-menu" class="screen">
        <h2>Multiplayer</h2>
        <input type="text" id="mp-name" placeholder="Enter Your Name" value="Player">
        <div class="btn-group">
            <button onclick="setupHost()">Host Game</button>
        </div>
        <p>OR</p>
        <div class="btn-group" style="align-items: center;">
            <input type="text" id="join-code" class="code-input" placeholder="9-CHAR CODE" maxlength="9" style="margin: 0; border-radius: 8px;">
        </div>
        <div class="btn-group">
            <button id="btn-join" onclick="joinGame()">Join Game</button>
        </div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-variant" class="screen">
        <h2>Select Game Type</h2>
        <div class="btn-group">
            <button onclick="selectVariant('normal')">Normal (3x3)</button>
            <button onclick="selectVariant('3d')">3D (3x3x3)</button>
            <button onclick="selectVariant('ultimate')">Ultimate</button>
        </div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-host-waiting" class="screen">
        <h2>Waiting for Opponent</h2>
        <p>Share this code:</p>
        <div id="host-code-display" class="code-box">Generating...</div>
        <p>Mode: <strong id="host-selected-mode" style="color:var(--primary)">-</strong></p>
        <div id="host-status" style="font-style: italic; color: #999;">Waiting for connection...</div>
        <button class="back-link" onclick="goBack('screen-mp-menu')">Cancel</button>
    </div>

    <div id="screen-difficulty" class="screen">
        <h2>Select Difficulty</h2>
        <div class="btn-group">
            <button onclick="startGameBot('easy')">Easy</button>
            <button onclick="startGameBot('medium')">Medium</button>
            <button onclick="startGameBot('hard')">Hard</button>
        </div>
        <button class="back-link" onclick="goBack('screen-variant')">Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="scoreboard">
            <div class="score-item">
                <div class="score-label" id="score-name-1">Player 1</div>
                <div id="score-val-1" class="score-val">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Draws</div>
                <div id="score-val-draw" class="score-val" style="color:#bbb;">0</div>
            </div>
            <div class="score-item">
                <div class="score-label" id="score-name-2">Player 2</div>
                <div id="score-val-2" class="score-val">0</div>
            </div>
        </div>

        <h3 id="game-title" style="color: #bbb; font-weight: 500;">TIC-TAC-TOE</h3>
        <div id="turn-display">X's Turn</div>

        <div id="board-container" style="margin-top: 25px;"></div>

        <button id="restart-btn" onclick="triggerRestart()">Play Next Round</button>
        <button class="back-link" onclick="location.reload()">Exit to Menu</button>
    </div>

<script>
    /* --- GLOBAL STATE --- */
    const state = {
        screen: 'screen-start',
        mode: null, 
        variant: null, 
        difficulty: null,
        p1Name: "Player 1",
        p2Name: "Player 2",
        scores: { p1: 0, p2: 0, draw: 0 },
        board: [], 
        turn: 'X',
        myPlayer: 'X', 
        active: false,
        ultimateMacro: [], 
        activeSubGrid: -1, 
        peer: null,
        conn: null
    };

    /* --- NAVIGATION --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        state.screen = id;
    }

    function goBack(target) { 
        if (state.peer) { state.peer.destroy(); state.peer = null; }
        showScreen(target); 
    }

    /* --- SETUP FLOWS --- */
    function setupLocal() {
        state.mode = 'local';
        showScreen('screen-local-setup');
    }

    function setupBot() {
        state.mode = 'bot';
        state.p1Name = "You";
        state.p2Name = "Bot";
        showScreen('screen-variant');
    }

    function setupMultiplayerMenu() {
        showScreen('screen-mp-menu');
    }

    function setupHost() {
        state.mode = 'host';
        state.p1Name = document.getElementById('mp-name').value || "Host";
        showScreen('screen-variant');
    }

    function finishSetup(from) {
        if (from === 'local') {
            state.p1Name = document.getElementById('local-p1').value || "Player 1";
            state.p2Name = document.getElementById('local-p2').value || "Player 2";
            showScreen('screen-variant');
        }
    }

    function selectVariant(v) {
        state.variant = v;
        if (state.mode === 'bot') {
            showScreen('screen-difficulty');
        } else if (state.mode === 'host') {
            startHostingProcess();
        } else {
            initGame(v);
        }
    }

    function startGameBot(diff) {
        state.difficulty = diff;
        state.p2Name = "Bot (" + diff + ")";
        state.myPlayer = 'X'; 
        initGame(state.variant);
    }

    /* --- GAME INIT --- */
    function initGame(variant) {
        showScreen('screen-game');
        state.active = true;
        state.turn = 'X';
        state.board = [];
        state.ultimateMacro = Array(9).fill(null);
        state.activeSubGrid = -1;

        document.getElementById('restart-btn').style.display = 'none';
        document.getElementById('game-title').innerText = variant.toUpperCase();
        updateScoreboard();
        updateTurnDisplay();

        const container = document.getElementById('board-container');
        container.innerHTML = '';

        if (variant === 'normal') initNormal(container);
        else if (variant === '3d') init3D(container);
        else if (variant === 'ultimate') initUltimate(container);
    }

    function updateScoreboard() {
        document.getElementById('score-name-1').innerText = state.p1Name + " (X)";
        document.getElementById('score-name-2').innerText = state.p2Name + " (O)";
        document.getElementById('score-val-1').innerText = state.scores.p1;
        document.getElementById('score-val-2').innerText = state.scores.p2;
        document.getElementById('score-val-draw').innerText = state.scores.draw;
    }

    /* --- RENDERERS --- */
    function createCell(idx) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.idx = idx;
        cell.onclick = () => handleInput(idx);
        return cell;
    }

    function initNormal(container) {
        const grid = document.createElement('div');
        grid.id = 'board-normal';
        state.board = Array(9).fill(null);
        for (let i = 0; i < 9; i++) grid.appendChild(createCell(i));
        container.appendChild(grid);
    }

    function init3D(container) {
        const wrapper = document.createElement('div');
        wrapper.id = 'board-3d';
        state.board = Array(27).fill(null); 
        for (let z = 0; z < 3; z++) {
            const layerBox = document.createElement('div');
            layerBox.className = 'level-container';
            const label = document.createElement('div');
            label.className = 'layer-label';
            label.innerText = `Level ${z+1}`;
            layerBox.appendChild(label);
            const layer = document.createElement('div');
            layer.className = 'layer-3d';
            for (let y = 0; y < 3; y++) for (let x = 0; x < 3; x++) {
                layer.appendChild(createCell(z*9 + y*3 + x));
            }
            layerBox.appendChild(layer);
            wrapper.appendChild(layerBox);
        }
        container.appendChild(wrapper);
    }

    function initUltimate(container) {
        const grid = document.createElement('div');
        grid.id = 'board-ultimate';
        state.board = Array(81).fill(null); 
        for (let i = 0; i < 9; i++) {
            const sub = document.createElement('div');
            sub.className = 'sub-grid active-zone'; 
            sub.id = `sub-${i}`;
            for (let j = 0; j < 9; j++) sub.appendChild(createCell(i*9 + j));
            grid.appendChild(sub);
        }
        container.appendChild(grid);
    }

    /* --- INPUT HANDLING --- */
    function handleInput(idx) {
        if (!state.active) return;
        if (state.mode !== 'local' && state.turn !== state.myPlayer) return;

        if (!isValidMove(idx)) return;

        makeMove(idx, state.turn);
        
        if ((state.mode === 'host' || state.mode === 'join') && state.conn) {
            state.conn.send({ type: 'move', idx: idx });
        }
        if (state.mode === 'bot' && state.active) {
            setTimeout(botMove, 500); 
        }
    }

    function isValidMove(idx) {
        if (state.board[idx] !== null) return false;
        if (state.variant === 'ultimate') {
            const subGridIdx = Math.floor(idx / 9);
            if (state.activeSubGrid !== -1 && subGridIdx !== state.activeSubGrid) return false;
            if (state.ultimateMacro[subGridIdx] !== null) return false;
        }
        return true;
    }

    function makeMove(idx, player) {
        state.board[idx] = player;
        renderCell(idx, player);

        let won = false;
        if (state.variant === 'normal') won = checkWinNormal(state.board, player);
        else if (state.variant === '3d') won = checkWin3D(state.board, player);
        else if (state.variant === 'ultimate') won = handleUltimateMove(idx, player);

        if (won) {
            endGame(player);
        } else if (isDraw()) {
            endGame('draw');
        } else {
            state.turn = state.turn === 'X' ? 'O' : 'X';
            updateTurnDisplay();
            if (state.variant === 'ultimate') highlightActiveSubGrids();
        }
    }

    function renderCell(idx, player) {
        let el;
        if(state.variant === 'normal') el = document.querySelector(`#board-normal .cell[data-idx='${idx}']`);
        else if(state.variant === '3d') el = document.querySelector(`.layer-3d .cell[data-idx='${idx}']`);
        else if(state.variant === 'ultimate') el = document.querySelector(`#board-ultimate .cell[data-idx='${idx}']`);
        if (el) {
            el.innerHTML = `<span>${player}</span>`; 
            el.classList.add(player.toLowerCase(), 'taken');
        }
    }

    function updateTurnDisplay() {
        const el = document.getElementById('turn-display');
        const pName = state.turn === 'X' ? state.p1Name : state.p2Name;
        
        if (state.mode === 'local') {
            el.innerText = `${pName}'s Turn (${state.turn})`;
            el.style.color = state.turn === 'X' ? "var(--text)" : "var(--primary)";
        } else {
            if (state.turn === state.myPlayer) {
                el.innerText = "Your Turn";
                el.style.color = "var(--primary)";
            } else {
                el.innerText = `${pName}'s Turn`;
                el.style.color = "#999";
            }
        }
    }

    function endGame(result) {
        state.active = false;
        const display = document.getElementById('turn-display');
        if (result === 'draw') {
            display.innerText = "It's a Draw!";
            state.scores.draw++;
        } else {
            const winnerName = result === 'X' ? state.p1Name : state.p2Name;
            display.innerText = `${winnerName} Wins!`;
            display.style.color = result === 'X' ? "var(--text)" : "var(--primary)";
            if (result === 'X') state.scores.p1++; else state.scores.p2++;
            fireConfetti();
        }
        updateScoreboard();
        document.getElementById('restart-btn').style.display = 'inline-block';
    }

    function fireConfetti() {
        if(window.confetti) confetti({ 
            particleCount: 150, 
            spread: 70, 
            origin: { y: 0.6 }, 
            colors: ['#DD8566', '#474D4D', '#DBDCDF'] 
        });
    }

    /* --- LOGIC HELPERS --- */
    const WINS_3X3 = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    function checkWinNormal(b, p) { return WINS_3X3.some(c => c.every(i => b[i] === p)); }
    function checkWin3D(b, p) {
        const checkLine = (sx,sy,sz, dx,dy,dz) => {
            for(let i=0; i<3; i++) if (b[(sz+i*dz)*9 + (sy+i*dy)*3 + (sx+i*dx)] !== p) return false;
            return true;
        };
        for(let z=0; z<3; z++) for(let y=0; y<3; y++) if(checkLine(0,y,z, 1,0,0)) return true;
        for(let z=0; z<3; z++) for(let x=0; x<3; x++) if(checkLine(x,0,z, 0,1,0)) return true;
        for(let y=0; y<3; y++) for(let x=0; x<3; x++) if(checkLine(x,y,0, 0,0,1)) return true;
        for(let z=0; z<3; z++) { if(checkLine(0,0,z, 1,1,0)) return true; if(checkLine(2,0,z, -1,1,0)) return true; }
        for(let y=0; y<3; y++) { if(checkLine(0,y,0, 1,0,1)) return true; if(checkLine(2,y,0, -1,0,1)) return true; }
        for(let x=0; x<3; x++) { if(checkLine(x,0,0, 0,1,1)) return true; if(checkLine(x,2,0, 0,-1,1)) return true; }
        if(checkLine(0,0,0, 1,1,1)) return true; if(checkLine(2,0,0, -1,1,1)) return true;
        if(checkLine(0,2,0, 1,-1,1)) return true; if(checkLine(2,2,0, -1,-1,1)) return true;
        return false;
    }

    function handleUltimateMove(idx, p) {
        const subIdx = Math.floor(idx/9);
        const subArr = state.board.slice(subIdx*9, subIdx*9+9);
        if (state.ultimateMacro[subIdx] === null && checkWinNormal(subArr, p)) {
            state.ultimateMacro[subIdx] = p;
            document.getElementById(`sub-${subIdx}`).classList.add(p==='X'?'won-x':'won-o');
        }
        const rel = idx % 9;
        if (state.ultimateMacro[rel] !== null || isSubGridFull(rel)) state.activeSubGrid = -1;
        else state.activeSubGrid = rel;
        highlightActiveSubGrids();
        return checkWinNormal(state.ultimateMacro, p);
    }

    function highlightActiveSubGrids() {
        for(let i=0; i<9; i++) {
            const sub = document.getElementById(`sub-${i}`);
            sub.classList.remove('active-zone');
            if(state.ultimateMacro[i]) continue;
            if (state.activeSubGrid === -1 || state.activeSubGrid === i) sub.classList.add('active-zone');
        }
    }
    function isSubGridFull(idx) { for(let i=0;i<9;i++) if(state.board[idx*9+i]===null) return false; return true; }
    function isDraw() { return state.board.every(c => c !== null); }

    /* --- BOT --- */
    function botMove() {
        let moves = [];
        for(let i=0;i<state.board.length;i++) if(isValidMove(i)) moves.push(i);
        if(moves.length===0) return;
        const rand = Math.random();
        let idx = -1;
        if (state.difficulty==='easy') idx = moves[Math.floor(Math.random()*moves.length)];
        else {
            if (rand > (state.difficulty==='medium'?0.7:0.95)) idx = moves[Math.floor(Math.random()*moves.length)];
            else idx = findBestMove(moves);
        }
        makeMove(idx, 'O');
    }
    function findBestMove(moves) {
        for(let m of moves) { let t=[...state.board]; t[m]='O'; if(checkWinSim(t,'O')) return m; }
        for(let m of moves) { let t=[...state.board]; t[m]='X'; if(checkWinSim(t,'X')) return m; }
        return moves[Math.floor(Math.random()*moves.length)];
    }
    function checkWinSim(b, p) {
        if(state.variant==='normal') return checkWinNormal(b,p);
        if(state.variant==='3d') return checkWin3D(b,p);
        return false;
    }

    /* --- NETWORK --- */
    function makeId(l) {
        const c='abcdefghijklmnopqrstuvwxyz0123456789'; let r='';
        for(let i=0;i<l;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r;
    }

    function startHostingProcess() {
        showScreen('screen-host-waiting');
        document.getElementById('host-selected-mode').innerText = state.variant.toUpperCase();
        const customId = makeId(9);
        state.peer = new Peer(customId);
        
        state.peer.on('open', (id) => { 
            document.getElementById('host-code-display').innerText = id; 
        });
        state.peer.on('error', () => { state.peer.destroy(); startHostingProcess(); });

        state.peer.on('connection', (c) => {
            state.conn = c;
            document.getElementById('host-status').innerText = "Connecting...";
            setupConn();

            c.on('open', () => {
                c.send({ 
                    type: 'start', 
                    variant: state.variant, 
                    hostName: state.p1Name 
                });
                state.myPlayer = 'X';
                initGame(state.variant);
            });
        });
    }

    function joinGame() {
        state.mode = 'join';
        const name = document.getElementById('mp-name').value || "Joiner";
        const code = document.getElementById('join-code').value.trim().toLowerCase();
        if (!code || code.length !== 9) return alert("Enter 9-char code");
        
        state.p2Name = name;
        document.getElementById('btn-join').innerText = "Connecting...";
        
        state.peer = new Peer(); 
        state.peer.on('open', () => {
            state.conn = state.peer.connect(code);
            setupConn();
        });
        state.peer.on('error', () => { alert("Connection Failed"); location.reload(); });
    }

    function setupConn() {
        state.conn.on('data', (data) => {
            if (data.type === 'start') {
                state.variant = data.variant;
                state.p1Name = data.hostName; 
                state.p2Name = document.getElementById('mp-name').value;
                state.conn.send({ type: 'name-ack', name: state.p2Name });
                state.myPlayer = 'O'; 
                initGame(state.variant);
            }
            if (data.type === 'name-ack') {
                state.p2Name = data.name;
                updateScoreboard();
                updateTurnDisplay();
            }
            if (data.type === 'move') {
                makeMove(data.idx, state.myPlayer === 'X' ? 'O' : 'X');
            }
            if (data.type === 'restart') initGame(state.variant);
        });
        
        state.conn.on('close', () => alert("Opponent Disconnected"));
    }

    function triggerRestart() {
        initGame(state.variant);
        if ((state.mode === 'host' || state.mode === 'join') && state.conn) {
            state.conn.send({ type: 'restart' });
        }
    }
</script>
</body>
</html>
